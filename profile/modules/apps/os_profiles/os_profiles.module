<?php

/**
 * @file
 * Profiles and person customisations.
 */

use Drupal\Core\Entity\EntityInterface;
use Drupal\Core\Form\FormStateInterface;
use Drupal\Core\Url;
use Drupal\file\Entity\File;
use Drupal\views\Plugin\views\query\QueryPluginBase;
use Drupal\views\ViewExecutable;

/**
 * Implements hook_form_alter().
 */
function os_profiles_form_alter(&$form, FormStateInterface $form_state, $form_id) {
  if ($form_id === 'node_person_form' || $form_id === 'node_person_edit_form') {
    $form['title']['#access'] = FALSE;
  }
}

/**
 * Implements hook_ENTITY_TYPE_presave().
 *
 * Fill hidden Title field with full name derived from other fields.
 */
function os_profiles_node_presave(EntityInterface $entity) {
  if ($entity->bundle() === 'person') {
    $honorific = $entity->field_honorific->value;
    $first_name = $entity->field_first_name->value;
    $middle_name = $entity->field_middle_name->value;
    $last_name = $entity->field_last_name->value;
    $full_name = ($honorific ? $honorific . ' ' : '') . ($first_name ? $first_name . ' ' : '') . ($middle_name ? $middle_name . ' ' : '') . $last_name;
    $entity->setTitle($full_name);
  }
}

/**
 * Implements hook_theme().
 */
function os_profiles_theme($existing, $type, $theme, $path) {
  return [
    'os_profiles_example_hover_popup' => [
      'variables' => [
        'counter' => 0,
        'label' => '',
        'profile_example' => '',
      ],
    ],
    'os_profiles_example_title' => [
      'variables' => [],
    ],
    'os_profiles_example_teaser' => [
      'variables' => [
        'image' => '',
      ],
    ],
    'os_profiles_example_sidebar_teaser' => [
      'variables' => [
        'image' => '',
      ],
    ],
    'os_profiles_example_slide_teaser' => [
      'variables' => [],
    ],
    'os_profiles_example_no_image_teaser' => [
      'variables' => [],
    ],
  ];
}

/**
 * Implements hook_preprocess_node().
 */
function os_profiles_preprocess_node(&$variables) {
  /** @var \Drupal\node\Entity\Node $node */
  $node = $variables['node'];
  // Node bundle is person.
  if ($node->bundle() != 'person') {
    return;
  }
  $content = $variables['content'];
  $config = Drupal::config('os_profiles.settings');

  // Current view mode has image.
  // Person image is empty.
  // Default image is not hidden.
  if (in_array($variables['view_mode'], ['teaser', 'sidebar_teaser', 'full'])
    && empty($content['field_photo_person']['#items'])
    && !$config->get('disable_default_image')) {

    $default_image_fid = $config->get('default_image_fid');
    if ($default_image_fid && $file = File::load($default_image_fid)) {
      $image_style_name = 'crop_photo_person';
      if ($variables['view_mode'] == 'full') {
        $image_style_name = 'crop_photo_person_full';
      }
      $image_vars = [
        'style_name' => $image_style_name,
        'uri' => $file->getFileUri(),
      ];

      // The image.factory service will check if our image is valid.
      $image = \Drupal::service('image.factory')->get($file->getFileUri());
      if ($image->isValid()) {
        $image_vars['width'] = $image->getWidth();
        $image_vars['height'] = $image->getHeight();
      }
      else {
        $image_vars['width'] = $image_vars['height'] = NULL;
      }

      $default_image_render_array = [
        '#theme' => 'image_style',
        '#width' => $image_vars['width'],
        '#height' => $image_vars['height'],
        '#style_name' => $image_vars['style_name'],
        '#uri' => $image_vars['uri'],
        '#attributes' => [
          'class' => ['person-default-image'],
        ],
      ];
    }
    else {
      // Use default image.
      $image_name = 'person-default-image.png';
      if ($variables['view_mode'] == 'full') {
        $image_name = 'person-default-image-big.png';
      }
      $default_image_render_array = [
        '#theme' => 'image',
        '#uri' => file_create_url(drupal_get_path('theme', 'os_base') . '/images/' . $image_name),
        "#alt" => t('default-image'),
        '#attributes' => [
          'class' => ['person-default-image'],
        ],
      ];
    }
    $variables['content']['field_photo_person'][0] = $default_image_render_array;
  }

  if (!empty($content['field_phone'][0])) {
    $variables['content']['field_phone']['#title'] = t('p', ['context' => 'Field phone title']);
  }
  if (!empty($content['field_email'][0]['#url'])) {
    $url_attributes = [
      'title' => t("@title's e - mail", ['@title' => $node->getTitle()]),
    ];
    $variables['content']['field_email'][0]['#url']->setOption('attributes', $url_attributes);
  }
  /** @var \Drupal\vsite\Plugin\VsiteContextManager $vsite_context_manager */
  $vsite_context_manager = Drupal::service('vsite.context_manager');
  // Mark person nodes without images.
  // Invalidate if profile settings are changed.
  if ($node->bundle() == 'person' && empty($content['field_photo_person']['#items']) && $group = $vsite_context_manager->getActiveVsite()) {
    $variables['#cache']['tags'][] = 'node-person-without-image:' . $group->id();
  }
}

/**
 * Implements hook_entity_view_mode_alter().
 */
function os_profiles_entity_view_mode_alter(&$view_mode, EntityInterface $entity, $context) {
  if ($entity->getEntityType() != 'node' && $entity->bundle() != 'person') {
    return;
  }
  /** @var \Symfony\Component\HttpFoundation\ParameterBag $attributes */
  $attributes = Drupal::request()->attributes;
  $parameters = $attributes->all();
  if (empty($parameters['_route']) || $parameters['_route'] != 'view.people.page_1') {
    return;
  }
  $profiles_view_mode = Drupal::config('os_profiles.settings')->get('display_type');
  if (empty($profiles_view_mode)) {
    return;
  }
  $view_mode = $profiles_view_mode;
}

/**
 * Implements hook_views_pre_build().
 */
function os_profiles_views_pre_build(ViewExecutable $view) {
  if ($view->id() != 'people' || $view->current_display != 'page_1') {
    return;
  }
  /** @var \Drupal\vsite\Plugin\VsiteContextManager $vsite_context_manager */
  $vsite_context_manager = Drupal::service('vsite.context_manager');
  // Mark people views and invalidate if display type changed.
  if ($group = $vsite_context_manager->getActiveVsite()) {
    $view->storage->addCacheTags(['view:people:page:' . $group->id()]);
  }
}

/**
 * Implements hook_views_query_alter() for preventing the sql syntax error exception.
 */
function os_profiles_views_query_alter(ViewExecutable $view, QueryPluginBase $query) {
  if ($view->id() !== 'people' && $view->current_display !== 'people_glossary') {
    return;
  }
  // Specifically to correct the sql syntax for people glossary.
  foreach ($query->where as &$condition_group) {
    foreach ($condition_group['conditions'] as &$condition) {
      if (strpos($condition['field'], 'field_last_name') !== FALSE) {
        $placeHolder = array_keys($condition['value'])[0];
        // If array is passed in arguments such as {a,b,c,d,e} we need to
        // make sure correct sql syntax is followed otherwise site breaks with
        // an exception.
        if (is_array($value = $condition['value'][$placeHolder])) {
          unset($condition['value'][$placeHolder]);
          $condition['field'] = "SUBSTRING(node__field_last_name.field_last_name_value, 1, 1) IN(" . $placeHolder . "[])";
          $condition['value'][$placeHolder . "[]"] = $value;
        }
      }
    }
  }
}

/**
 * Implements hook_preprocess_HOOK().
 */
function os_profiles_preprocess_views_view_summary(&$variables) {
  // Targets only view name 'people' for alphabetical profile
  // glossary link display.
  if ($variables['view']->id() == 'people' && $variables['view']->current_display == 'block_2') {

    $options = $variables['view']->style_plugin->options;
    $summary_base_path = Url::fromUri('internal:/' . $options['base_path'])->toString();
    $glossary_links = [
      'A-E' => range('a', 'e'),
      'F-J' => range('f', 'j'),
      'K-O' => range('k', 'o'),
      'P-T' => range('p', 't'),
      'U-Z' => range('u', 'z'),
    ];
    // Building the glossary links as A-E, F-J etc.
    foreach ($variables['view']->result as $letter) {
      $rendered[] = strtolower($letter->field_last_name_value_truncated);
    }
    $rows = [];
    foreach ($glossary_links as $key => $alphabet_set) {
      if (array_intersect($rendered, $alphabet_set)) {
        $overridden_result = new stdClass();
        $overridden_result->link = $key;
        $overridden_result->url = $summary_base_path . '/' . implode(',', $glossary_links[$key]);
        $rows[] = $overridden_result;
      }
    }
    $variables['rows'] = $rows;
  }
}
